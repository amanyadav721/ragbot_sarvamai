<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Chat</title>
    <link rel="stylesheet" href="/static/styles.css">
    <style>
        /* Add some basic styles for the microphone button */
        .mic-button {
            background-color: #f0f0f0;
            border: none;
            cursor: pointer;
            padding: 10px;
            margin-left: 10px;
            border-radius: 50%;
            font-size: 16px;
        }
        .mic-button.active {
            background-color: #ff4b4b;
            color: white;
        }
        /* Style for language selector */
        .language-selector {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PDF Chat</h1>
        
        <!-- Language Selector -->
        <div class="language-selector">
            <label for="language-select"><strong>Select Language:</strong></label>
            <select id="language-select">
                <option value="en-US">English (US)</option>
                <option value="hi-IN">Hindi (India)</option>
                <option value="bn-IN">Bengali (India)</option>
                <option value="kn-IN">Kannada (India)</option>
                <option value="ml-IN">Malayalam (India)</option>
                <option value="mr-IN">Marathi (India)</option>
                <option value="od-IN">Odia (India)</option>
                <option value="pa-IN">Punjabi (India)</option>
                <option value="ta-IN">Tamil (India)</option>
                <option value="te-IN">Telugu (India)</option>
                <option value="gu-IN">Gujarati (India)</option>
            </select>
        </div>
        
        <!-- Chat History -->
        <div id="chat-history"></div>
        
        <!-- Input Group for Standard Questions -->
        <div class="input-group">
            <input type="text" id="standard-question-input" placeholder="Ask a question...">
            <button onclick="askStandardQuestion()">Ask</button>
            <!-- Microphone Button for Standard Questions -->
            <button class="mic-button" id="standard-mic-button" onclick="toggleStandardRecording()">ðŸŽ¤</button>
        </div>
        
        <!-- Input Group for Agent-Driven Actions -->
        <div class="input-group">
            <input type="text" id="agent-question-input" placeholder="Ask an Agent...">
            <button onclick="askAgentQuestion()">Ask Agent</button>
            <!-- Microphone Button for Agent Questions -->
            <button class="mic-button" id="agent-mic-button" onclick="toggleAgentRecording()">ðŸŽ¤</button>
        </div>
    </div>

    <script>
        // Function to get the selected language
        function getSelectedLanguage() {
            const languageSelect = document.getElementById('language-select');
            return languageSelect.value;
        }

        // Check for browser support
        window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;

        if (window.SpeechRecognition === null) {
            alert('Your browser does not support Speech Recognition. Please use a supported browser like Chrome.');
        } else {
            let standardRecognizer = null;
            let agentRecognizer = null;

            // Initialize Speech Recognizers with dynamic language
            function initializeRecognizers() {
                // If recognizers already exist, stop them
                if (standardRecognizer) {
                    standardRecognizer.stop();
                }
                if (agentRecognizer) {
                    agentRecognizer.stop();
                }

                // Create new recognizers with the selected language
                standardRecognizer = new window.SpeechRecognition();
                standardRecognizer.continuous = false;
                standardRecognizer.interimResults = false;
                standardRecognizer.lang = getSelectedLanguage();

                agentRecognizer = new window.SpeechRecognition();
                agentRecognizer.continuous = false;
                agentRecognizer.interimResults = false;
                agentRecognizer.lang = getSelectedLanguage();

                // Standard Question Recognition
                standardRecognizer.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('standard-question-input').value = transcript;
                    askStandardQuestion();
                    toggleStandardRecording(false);
                };

                standardRecognizer.onerror = function(event) {
                    console.error('Standard Recognition Error:', event.error);
                    alert('Error recognizing your speech. Please try again.');
                    toggleStandardRecording(false);
                };

                // Agent Question Recognition
                agentRecognizer.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('agent-question-input').value = transcript;
                    askAgentQuestion();
                    toggleAgentRecording(false);
                };

                agentRecognizer.onerror = function(event) {
                    console.error('Agent Recognition Error:', event.error);
                    alert('Error recognizing your speech. Please try again.');
                    toggleAgentRecording(false);
                };
            }

            initializeRecognizers();

            document.getElementById('language-select').addEventListener('change', function() {
                initializeRecognizers();
            });

            function toggleStandardRecording(start = true) {
                const micButton = document.getElementById('standard-mic-button');
                if (start) {
                    try {
                        standardRecognizer.start();
                        micButton.classList.add('active');
                    } catch (e) {
                        console.error('Standard Recognizer Start Error:', e);
                        alert('Could not start speech recognition. Please try again.');
                    }
                } else {
                    standardRecognizer.stop();
                    micButton.classList.remove('active');
                }
            }

            function toggleAgentRecording(start = true) {
                const micButton = document.getElementById('agent-mic-button');
                if (start) {
                    try {
                        agentRecognizer.start();
                        micButton.classList.add('active');
                    } catch (e) {
                        console.error('Agent Recognizer Start Error:', e);
                        alert('Could not start speech recognition. Please try again.');
                    }
                } else {
                    agentRecognizer.stop();
                    micButton.classList.remove('active');
                }
            }
        }

        async function askStandardQuestion() {
            const questionInput = document.getElementById('standard-question-input');
            const question = questionInput.value.trim();
            const language = getSelectedLanguage();

            if (question === '') {
                alert('Please enter a question.');
                return;
            }

            try {
                const response = await fetch('/ask_question/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ question: question, language: language })
                });

                if (response.ok) {
                    const result = await response.json();
                    displayMessage('You', question);
                    displayMessage('AI', result.answer);
                    questionInput.value = '';
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to get an answer');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while asking the question.');
            }
        }

        async function askAgentQuestion() {
            const questionInput = document.getElementById('agent-question-input');
            const question = questionInput.value.trim();
            const language = getSelectedLanguage();

            if (question === '') {
                alert('Please enter a question.');
                return;
            }

            try {
                const response = await fetch('/agent_action/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ question: question, language: language })
                });

                if (response.ok) {
                    const result = await response.json();
                    displayMessage('You', question);
                    displayMessage('Agent', result.answer);
                    questionInput.value = '';
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to get an answer');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while asking the Agent.');
            }
        }

        function displayMessage(sender, message) {
            const chatHistory = document.getElementById('chat-history');
            const messageElement = document.createElement('p');
            if (sender === 'You') {
                messageElement.className = 'user-message';
            } else if (sender === 'AI') {
                messageElement.className = 'ai-message';
            } else if (sender === 'Agent') {
                messageElement.className = 'agent-message';
            }
            messageElement.innerHTML = `<strong>${sender}:</strong> ${message}`;
            chatHistory.appendChild(messageElement);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
    </script>
</body>
</html>
